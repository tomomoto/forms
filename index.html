<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.2/knockout-min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css" rel="stylesheet"/>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"
            integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.min.js"></script>
    <link href="css/s2-docs.css" type="text/css" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css"
          integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js"
            integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb"
            crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js"
            integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn"
            crossorigin="anonymous"></script>
</head>
<body>
<div class="container">
    <h3>Уточненные критерии выгрузки информации о лицах </h3>
    <hr>
    <div class="row">
        <div class="col-3">
            <p>Идентификаторы</p>
        </div>
        <div class="col-9">
            <select multiple="multiple" data-bind="selectedOptions: ids, valueAllowUnset: true, select2: { tags:true,
            placeholder: 'Укажите идентификаторы пользователей', allowClear: true,  tokenSeparators: [',', ' '] }" style="width: 100%"></select>
        </div>
    </div>
    <hr>
    <div class="row">
        <div class="col-3">
            <p>Ники пользователей</p>
        </div>
        <div class="col-9">
            <select multiple="multiple" data-bind="selectedOptions: screenNames, valueAllowUnset: true, select2: { tags:true,
            placeholder: 'Укажите ники пользователей', allowClear: true, tokenSeparators: [','] }" style="width: 100%"></select>
        </div>
    </div>
    <hr>
    <div class="row">
        <div class="col-3">
            <p>ФИО, ключевые слова</p>
        </div>
        <div class="col-9">
            <select data-bind="value: query, valueAllowUnset: true, select2: { tags:true,
            placeholder: 'Укажите ФИО, ключевые слова', allowClear: true }" style="width: 100%"></select>
        </div>
    </div>
    <hr>
    <div class="row">
        <div class="col">
            <h5>Географический регион</h5>
        </div>
    </div>
    <div class="row">
        <div class="col-3">
            <p>Выберите страну</p>
        </div>
        <div class="col-9">
            <select class="js-data-example-ajax" style="width: 100%;">
            </select>
        </div>
    </div>
    <div class="row">
        <div class="col-3">
            <p>Код страны</p>
        </div>
        <div class="col-9">
            <div class="form-group">
                <input type="text" class="form-control" id="countryCode">
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-3">
            <p>Идентификатор страны</p>
        </div>
        <div class="col-9">
            <div class="form-group">
                <input type="text" class="form-control" id="countryId">
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-3">
            <p>Выберите город</p>
        </div>
        <div class="col-9">
            <select class="js-data-example-ajax" data-bind="value: cityName, valueAllowUnset: true" style="width: 100%;">
            </select>
        </div>
    </div>
    <div class="row">
        <div class="col-3">
            <p>Идентификатор города</p>
        </div>
        <div class="col-9">
            <div class="form-group">
                <input type="text" class="form-control" id="cityId">
            </div>
        </div>
    </div>
    <hr>
    <div class="row">
        <div class="col">
            <h5>Учебное заведение</h5>
        </div>
    </div>
    <div class="row">
        <div class="col-3">
            <p>Школа</p>
        </div>
        <div class="col-9">
            <select class="js-data-example-ajax " style="width: 100%;">
                <option>Не указана</option>
            </select>
        </div>
    </div>
    <div class="row">
        <div class="col-3">
            <p>Университет</p>
        </div>
        <div class="col-9">
            <select class="js-data-example-ajax " style="width: 100%;">
                <option>Не указан</option>
            </select>
        </div>
    </div>
    <hr>
    <div class="row">
        <div class="col">
            <h5>Возраст</h5>
        </div>
    </div>
    <div class="row">
        <div class="col-3">
            <p>Нижняя граница</p>
        </div>
        <div class="col-9">
            <div class="form-group">
                <input type="text" class="form-control" data-bind="value: ageFrom">
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-3">
            <p>Верхняя граница</p>
        </div>
        <div class="col-9">
            <div class="form-group">
                <input type="text" class="form-control" data-bind="value: ageTo">
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-3">
            <p>Дата рождения</p>
        </div>
        <div class="col-9">
            <div class="form-group">
                <input type="text" class="form-control" data-bind="value: birthdate">
            </div>
        </div>
    </div>
    <hr>
    <div class="row">
        <div class="col-3">
            <h5>Пол</h5>
        </div>
        <div class="col-9">
            <select style="width: 100%;" data-bind="value: genderValue, options: genderOptions, valueAllowUnset: true,
            optionsText: 'text', optionsValue: 'value', select2: { tags:true, placeholder: 'Укажите пол', allowClear: true }"></select>
        </div>
    </div>
    <hr>
    <div class="row">
        <div class="col">
            <h5>Работа</h5>
        </div>
    </div>
    <div class="row">
        <div class="col-3">
            <p>Название компании</p>
        </div>
        <div class="col-9">
            <select data-bind="value: companyName, valueAllowUnset: true, select2: { tags:true,
            placeholder: 'Укажите название компании', allowClear: true }" style="width: 100%"></select>
        </div>
    </div>
    <div class="row">
        <div class="col-3">
            <p>Название должности</p>
        </div>
        <div class="col-9">
            <select data-bind="value: jobName, valueAllowUnset: true, select2: { tags:true,
            placeholder: 'Укажите название должности', allowClear: true }" style="width: 100%"></select>
        </div>
    </div>
    <hr>
    <div class="row">
        <div class="col-3">
            <p>Идентификатор группы, в которой состоит пользователь</p>
        </div>
        <div class="col-9">
            <div class="form-group">
                <input type="text" class="form-control" id="groupId">
            </div>
        </div>
    </div>
    <hr>
    <div class="row">
        <div class="col-3">
            <p>Выгружать списки пользователя</p>
        </div>
        <div class="col-9">
            <div class="checkbox">
                <label><input type="checkbox" value=""></label>
            </div>
        </div>
    </div>
    <hr>
    <div class="row">
        <div class="col-3">
            <p>Выгружать статистику по объектам пользователя</p>
        </div>
        <div class="col-9">
            <div class="checkbox">
                <label><input type="checkbox" value=""></label>
            </div>
        </div>
    </div>
    <hr>
    <button class="btn btn-success" onclick=formJsonRequest();>Сформировать JSON запрос</button>
    <button data-bind="click: incrementClickCounter">Click me</button>
</div>
<div>
    <p>Выбран пол: </p><span data-bind="text: genderValue"></span>

    <p>ФИО: </p><span data-bind="text: query"></span>

    <p>Ники: </p><span data-bind="text: screenNames"></span>

    <p>ids: </p><span data-bind="text: ids"></span>

    <p>city: </p><span data-bind="text: cityName"></span>
</div>
<script type="text/javascript">

    ko.bindingHandlers.select2 = {
        after: ["options", "value"],
        init: function (el, valueAccessor, allBindingsAccessor, viewModel) {
            $(el).select2(ko.unwrap(valueAccessor()));
            ko.utils.domNodeDisposal.addDisposeCallback(el, function () {
                $(el).select2('destroy');
            });
        },
        update: function (el, valueAccessor, allBindingsAccessor, viewModel) {
            var allBindings = allBindingsAccessor();
            var select2 = $(el).data("select2");
            if ("value" in allBindings) {
                var newValue = "" + ko.unwrap(allBindings.value);
                if ((allBindings.select2.multiple || el.multiple) && newValue.constructor !== Array) {
                    select2.val([newValue.split(",")]);
                }
                else {
                    select2.val([newValue]);
                }
            }
        }
    };

    var ViewModel = function() {
        this.ids = ko.observable();
        this.genderOptions = ko.observableArray([{value: "m", text: "Мужской"}, {value: "f", text: "Женский"}]);
        this.genderValue = ko.observable();
        this.ageFrom = ko.observable();
        this.ageTo = ko.observable();
        this.query = ko.observable();
        this.companyName = ko.observable();
        this.jobName = ko.observable();
        this.cityName = ko.observable();
        this.screenNames = ko.observable();
        this.birthdate = ko.observable();

        this.incrementClickCounter  = function() {
            alert(JSON.stringify(this.ids()));
        }

    };

    ko.applyBindings(new ViewModel());

    var formJsonRequest = function(){
        var request = {};
        alert(JSON.stringify(request));
    };


    $(".js-data-example-ajax").select2({
        placeholder : "TODO",
        allowClear: true,
        ajax: {
            url: "https://api.github.com/search/repositories",
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return {
                    q: params.term, // search term
                    page: params.page
                };
            },
            processResults: function (data, params) {
                // parse the results into the format expected by Select2
                // since we are using custom formatting functions we do not need to
                // alter the remote JSON data, except to indicate that infinite
                // scrolling can be used
                params.page = params.page || 1;

                return {
                    results: data.items,
                    pagination: {
                        more: (params.page * 30) < data.total_count
                    }
                };
            },
            cache: true
        },
        escapeMarkup: function (markup) {return markup;},
        minimumInputLength: 1,
        templateResult: formatRepo, // omitted for brevity, see the source of this page
        templateSelection: formatRepoSelection // omitted for brevity, see the source of this page
    });

    function formatRepo(repo) {
        if (repo.loading) return repo.text;

        var markup = "<div class='select2-result-repository clearfix'>" +
                "<div class='select2-result-repository__avatar'><img src='" + repo.owner.avatar_url + "' /></div>" +
                "<div class='select2-result-repository__meta'>" +
                "<div class='select2-result-repository__title'>" + repo.full_name + "</div>";

        if (repo.description) {
            markup += "<div class='select2-result-repository__description'>" + repo.description + "</div>";
        }

        markup += "<div class='select2-result-repository__statistics'>" +
                "<div class='select2-result-repository__forks'><i class='fa fa-flash'></i> " + repo.forks_count + " Forks</div>" +
                "<div class='select2-result-repository__stargazers'><i class='fa fa-star'></i> " + repo.stargazers_count + " Stars</div>" +
                "<div class='select2-result-repository__watchers'><i class='fa fa-eye'></i> " + repo.watchers_count + " Watchers</div>" +
                "</div>" +
                "</div></div>";

        return markup;
    }

    function formatRepoSelection(repo) {
        return repo.full_name || repo.text;
    }

</script>
</body>
</html>